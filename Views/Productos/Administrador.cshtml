@using GRINPLAS.ViewModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@{
  ViewData["Title"] = "Administrador";
  Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
  var token = Xsrf.GetAndStoreTokens(Context).RequestToken;
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
}

<div class="d-flex flex-column">
  <div class="container p-6 m-2">
    <div class="d-flex align-items-center small">
      <a href="#" class="text-muted" style="text-decoration: none">Inicio</a>
      <span class="mx-2">/</span>
      <span class="fw-bold" style="color: #09c33d">Historial de productos</span>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-4">
    <h1 class="display-6 ps-5 fw-semibold fs-2">Historial de Productos</h1>
  </div>

  <div class="mt-4 d-flex justify-content-between align-items-center ms-5 me-5">
    <div class="d-flex gap-3 text-muted">
      <p>Listado de productos</p>
    </div>
    <div class="d-flex gap-2 mb-3">
      <form method="get" asp-action="BuscarProductos" class="d-flex gap-2 mb-3">
        <div class="input-group border border-success rounded">
          <input type="text" id="nombreFiltro" name="nombreFiltro" class="form-control border-0"
            placeholder="Buscar por nombre..." value="@ViewData["nombreFiltro"]" />
        </div>
        <div class="input-group border border-success rounded">
          <select id="categoriaFiltro" name="categoriaFiltro" class="form-select border-0">
            <option value="0">Todas las categorías</option>
            @foreach (var categoria in Model.Categorias)
            {
              <option value="@categoria.CategoriaId">@categoria.Nombre</option>
            }
          </select>
        </div>
        <button id="btnFiltrar" class="btn btn-success ms-2" type="submit"
          style="width: 160px; height: 45px;">Filtrar</button>
        <button id="btnResetear" class="btn btn-outline-secondary ms-2" type="button" onclick="resetFilters()"
          style="width: 160px; height: 45px;">Resetear</button>
      </form>

      <!-- Botón separado -->
      <button id="btnExportExcel" class="btn btn-success ms-2" type="button" style="width: 180px; height: 45px;">
        <i class="fas fa-file-excel me-2"></i>Exportar Excel
      </button>


    </div>
  </div>

  <hr class="mt-2 ms-5 me-5" />
  <div class="mt-4 table-responsive ms-5 me-5">
    <form method="post" asp-action="ActualizarPedido" class="pedido-form">
      <table id="ordersTable" class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th style="width: 5%;">Id</th>
            <th style="width: 10%;">Imagen</th>
            <th style="width: 20%;">Nombre</th>
            <th style="width: 30%;">Descripción</th>
            <th style="width: 15%;">Categoría</th>
            <th style="width: 10%;">Precio</th>
            <th style="width: 10%;">Cantidad</th>
          </tr>
        </thead>
        <tbody>
          @foreach (var producto in Model.Productos)
          {
            <tr data-pedido-id="@producto.ProductoId">
              <input type="hidden" name="productoId" value="@producto.ProductoId" />
              <td>@producto.ProductoId</td>
              <td class="text-center">
                <img src="@producto.Imagen" alt="Producto Imagen" class="img-fluid" style="width:40px; height:40px" />
              </td>
              <td>@producto.Nombre</td>
              <td>@producto.Descripcion</td>
              <td>@producto.Categoria.Nombre</td>
              <td>@producto.Precio</td>
              <td>@producto.Stock</td>
            </tr>
          }
        </tbody>
      </table>
    </form>
  </div>
</div>

@section Scripts {
  <script src="~/js/administrador.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

  <script>
    function resetFilters() {
      document.getElementById("nombreFiltro").value = "";
      document.getElementById("categoriaFiltro").value = "0";
      window.location.href = '@Url.Action("Administrador", "Productos")';
    }

    $(document).ready(function () {
      var table = $('#ordersTable').DataTable({
        "pageLength": 4,
        "lengthChange": false,
        "language": {
          "paginate": {
            "previous": "Anterior",
            "next": "Siguiente"
          },
          "info": "Página _PAGE_ de _PAGES_",
          "infoEmpty": "No hay datos disponibles",
          "emptyTable": "No hay productos registrados",
          "search": "Buscar:"
        }
      });

      $('#btnExportExcel').click(function () {
        var tempTable = $('<table></table>');
        var headerRow = $('<tr></tr>');
        $('#ordersTable thead th').each(function () {
          headerRow.append($('<th></th>').text($(this).text()));
        });
        tempTable.append(headerRow);

        var allData = [];
        table.rows({ search: 'applied' }).every(function () {
          var rowData = this.data();
          allData.push(rowData);
        });

        allData.forEach(function (rowData) {
          var row = $('<tr></tr>');
          rowData.forEach(function (cellData) {
            row.append($('<td></td>').text(cellData));
          });
          tempTable.append(row);
        });

        var wb = XLSX.utils.table_to_book(tempTable[0], { sheet: "Productos" });
        XLSX.writeFile(wb, "Historial_Productos.xlsx");
      });
    });
  </script>
}
